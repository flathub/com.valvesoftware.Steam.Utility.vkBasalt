From 7cd22a16120d39e8f7d734dacd5dc8f43a4ffeee Mon Sep 17 00:00:00 2001
From: Stephan Lachnit <stephanlachnit@protonmail.com>
Date: Tue, 14 Jul 2020 11:43:16 +0200
Subject: [PATCH] add option to install library to private directory

Signed-off-by: Stephan Lachnit <stephanlachnit@protonmail.com>
---
 config/meson.build                         | 9 +++++++--
 config/{vkBasalt.json => vkBasalt.json.in} | 2 +-
 meson.build                                | 8 ++++++++
 meson_options.txt                          | 1 +
 src/meson.build                            | 2 --
 5 files changed, 17 insertions(+), 5 deletions(-)
 rename config/{vkBasalt.json => vkBasalt.json.in} (89%)

diff --git a/config/meson.build b/config/meson.build
index 370e725..a1b6128 100644
--- a/config/meson.build
+++ b/config/meson.build
@@ -2,5 +2,10 @@ data_dir = get_option('datadir')
 
 vulkan_layer_dir = join_paths(data_dir, 'vulkan', 'implicit_layer.d')
 
-install_data(['vkBasalt.json'],
-    install_dir: vulkan_layer_dir)
+configure_file(
+    input : 'vkBasalt.json.in',
+    output : 'vkBasalt.json',
+    configuration : {'ld_lib_dir_vkbasalt' : ld_lib_dir_vkbasalt},
+    install : true,
+    install_dir : vulkan_layer_dir,
+)
diff --git a/config/vkBasalt.json b/config/vkBasalt.json.in
similarity index 89%
rename from config/vkBasalt.json
rename to config/vkBasalt.json.in
index 83983e6..93bc6cb 100644
--- a/config/vkBasalt.json
+++ b/config/vkBasalt.json.in
@@ -3,7 +3,7 @@
   "layer" : {
     "name": "VK_LAYER_VKBASALT_post_processing",
     "type": "GLOBAL",
-    "library_path": "libvkbasalt.so",
+    "library_path": "@ld_lib_dir_vkbasalt@libvkbasalt.so",
     "api_version": "1.2.136",
     "implementation_version": "1",
     "description": "a post processing layer",
diff --git a/meson.build b/meson.build
index bc8995a..18182a2 100644
--- a/meson.build
+++ b/meson.build
@@ -2,6 +2,14 @@ project('vkBasalt', ['c', 'cpp'], default_options: ['c_std=c11', 'cpp_std=c++2a'
 
 vkBasalt_include_path = include_directories('./include', './include/spirv')
 
+lib_dir = get_option('libdir')
+ld_lib_dir_vkbasalt = ''
+
+if get_option('append_libdir_vkbasalt')
+    lib_dir = join_paths(lib_dir, 'vkbasalt')
+    ld_lib_dir_vkbasalt = get_option('prefix') + '/\$LIB/vkbasalt/'
+endif
+
 if get_option('with_so')
     subdir('src')
 endif
diff --git a/meson_options.txt b/meson_options.txt
index 6d14876..62f1bb9 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -1,2 +1,3 @@
 option('with_so', type : 'boolean', value : true, description : 'install the library')
 option('with_json', type : 'boolean', value : true, description : 'install the json')
+option('append_libdir_vkbasalt', type : 'boolean', value : false, description: 'Append "vkbasalt" to libdir path or not.')
diff --git a/src/meson.build b/src/meson.build
index 1f26729..a91bc12 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -40,8 +40,6 @@ vkBasalt_src = [
 
 x11_dep = dependency('x11')
 
-lib_dir = get_option('libdir')
-
 shared_library(meson.project_name().to_lower(), 
     vkBasalt_src, shader_include,
     include_directories : vkBasalt_include_path,
-- 
2.26.2

